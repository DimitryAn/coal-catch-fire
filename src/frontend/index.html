<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Загрузка CSV в БД</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
    }

    .mega-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 50px;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 900px;
      text-align: center;
    }

    h1 {
      margin: 0 0 20px 0;
      font-size: 24px;
      color: #2c3e50;
    }

    .drop-area {
      border: 2px dashed #3498db;
      border-radius: 8px;
      padding: 40px 20px;
      margin-bottom: 20px;
      cursor: pointer;
      transition: background 0.3s, border 0.3s;
    }

    .drop-area.highlight {
      background: #ecf9ff;
      border-color: #2980b9;
    }

    .drop-area p {
      margin: 0;
      color: #7f8c8d;
      font-size: 14px;
    }

    input[type="file"] {
      display: none;
    }

    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #2980b9;
    }

    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    .message {
      margin-top: 20px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    table {
      width: 650px;
      border-collapse: collapse;
      text-align: center;
      margin-bottom: 20px;
    }

    td {
      text-align: center;
      padding: 10px;
      border: 3px solid rgb(0, 0, 0);
    }

    .table--container {
      float: right;
      margin-left: 40px;
      margin-top: 40px;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .block-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    caption {
      text-align: center;
      width: 650px;
    }

    .out-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 30px;
    }

    .hidden {
      display: none;
    }

    .metrics-container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 40%;
      text-align: center;
      margin-left: 5%;
    }

    .output-container {
      display: flex;
      margin-top: 30px;
    }
  </style>
</head>

<body>

  <!-- Основная загрузка всех файлов -->
  <div class="mega-container">
    <div class="container">
      <h1>Загрузите CSV-файлы</h1>
      <div class="drop-area" id="mainDropArea">
        <p>Перетащите <strong>все файлы</strong> сюда или кликните, чтобы выбрать</p>
        <p style="font-size: 12px; color: #999;">Ожидаются: temperatures.csv, supplies.csv, weather.csv</p>
        <input type="file" id="mainFileInput" accept=".csv" multiple />
      </div>
      <button id="mainUploadBtn" disabled>Загрузить в базу</button>
      <div id="mainMessage"></div>
    </div>
  </div>

  <!-- Просмотр данных -->
  <div class="block-container">
    <div class="container" style="max-width: 400px; margin-top: 40px;">
      <h1>Просмотр данных</h1>
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <select id="tableSelect">
          <option value="temperatures">Температура штабелей</option>
          <option value="supplies">Поставки угля</option>
          <option value="weather">Погодные данные</option>
          <option value="fires">Реальные пожары</option>
        </select>
        <button id="loadDataBtn">Загрузить</button>
        <button id="exportCsvBtn">Экспорт в CSV</button>
      </div>
      <div id="dataMessage"></div>
      <div style="overflow-x: auto;">
        <table id="dataTable" border="1" style="width: 100%; border-collapse: collapse; display: none;">
          <thead>
            <tr></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Таблица прогнозов -->
    <div class="table--container">
      <h1>Таблица самовозгораний</h1>
      <button id="loadPredBtn">Загрузить таблицу</button>
      <div id="predMessage"></div>
      <div style="overflow-x: auto; margin-top: 10px;">
        <table id="predTable" border="1" style="width: 100%; border-collapse: collapse; display: none;">
          <thead>
            <tr></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Загрузка fires.csv -->
  <div class="out-container">
    <div class="container">
      <h1>Загрузите CSV-файл с реальными пожарами</h1>
      <div class="drop-area" id="firesDropArea">
        <p>Перетащите файл сюда или кликните, чтобы выбрать</p>
        <p style="font-size: 12px; color: #999;">Ожидается: fires.csv</p>
        <input type="file" id="firesFileInput" accept=".csv" />
      </div>
      <button id="firesUploadBtn" disabled>Загрузить в базу</button>
      <div id="firesMessage"></div>
    </div>
  </div>
  <div class="output-container">
    <div class="metrics-container">
      <h1>Метрики</h1>
      <button id="loadMetricsBtn">Загрузить таблицу</button>
      <div id="MetricsMessage"></div>
      <div style="overflow-x: auto; margin-top: 10px;">
        <table id="MetricsTable" border="1" style="width: 100%; border-collapse: collapse; display: none;">
          <thead>
            <tr></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="table--container" style="margin-top: 0px;">
      <h1>Таблица истинных возгораний</h1>
      <button id="loadTrueBtn">Загрузить таблицу</button>
      <div id="TrueMessage"></div>
      <div style="overflow-x: auto; margin-top: 10px;">
        <table id="TrueTable" border="1" style="width: 100%; border-collapse: collapse; display: none;">
          <thead>
            <tr></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // === 1. Загрузка нескольких файлов (temperatures, supplies, weather) ===
    const mainDropArea = document.getElementById('mainDropArea');
    const mainFileInput = document.getElementById('mainFileInput');
    const mainUploadBtn = document.getElementById('mainUploadBtn');
    const mainMessage = document.getElementById('mainMessage');

    mainDropArea.addEventListener('click', () => mainFileInput.click());

    mainFileInput.addEventListener('change', () => {
      if (mainFileInput.files.length > 0) {
        mainDropArea.innerHTML = `<p>Выбрано файлов: ${mainFileInput.files.length}</p>`;
        mainUploadBtn.disabled = false;
        mainMessage.innerHTML = '';
      }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
      mainDropArea.addEventListener(event, e => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ['dragenter', 'dragover'].forEach(event => {
      mainDropArea.addEventListener(event, () => {
        mainDropArea.classList.add('highlight');
      });
    });

    ['dragleave', 'drop'].forEach(event => {
      mainDropArea.addEventListener(event, () => {
        mainDropArea.classList.remove('highlight');
      });
    });

    mainDropArea.addEventListener('drop', e => {
      e.preventDefault();
      mainFileInput.files = e.dataTransfer.files;
      if (e.dataTransfer.files.length > 0) {
        mainDropArea.innerHTML = `<p>Выбрано файлов: ${e.dataTransfer.files.length}</p>`;
        mainUploadBtn.disabled = false;
        mainMessage.innerHTML = '';
      }
    });

    mainUploadBtn.addEventListener('click', async () => {
      const files = Array.from(mainFileInput.files);
      if (files.length === 0) return;

      const formData = new FormData();
      files.forEach(file => formData.append('files', file));

      mainMessage.innerHTML = `<p>Загрузка ${files.length} файлов...</p>`;
      mainUploadBtn.disabled = true;

      try {
        const response = await fetch('/upload-multiple-csv/', {
          method: 'POST',
          body: formData,
        });
        const result = await response.json();

        let msg = `<div class="message success">✅ ${result.message || result.warning}</div>`;
        if (result.missing) {
          msg += `<div style="margin-top: 10px; color: #e67e22;">⚠️ Не хватает: ${result.missing.join(', ')}</div>`;
        }
        mainMessage.innerHTML = msg;
      } catch (error) {
        mainMessage.innerHTML = `<div class="message error">❌ Ошибка: ${error.message}</div>`;
      } finally {
        mainUploadBtn.disabled = false;
      }
    });

    // === 2. Загрузка fires.csv ===
    const firesDropArea = document.getElementById('firesDropArea');
    const firesFileInput = document.getElementById('firesFileInput');
    const firesUploadBtn = document.getElementById('firesUploadBtn');
    const firesMessage = document.getElementById('firesMessage');

    // Клик
    firesDropArea.addEventListener('click', () => firesFileInput.click());

    // Выбор файла
    firesFileInput.addEventListener('change', () => {
      if (firesFileInput.files.length > 0) {
        firesDropArea.innerHTML = `<p>Выбран: ${firesFileInput.files[0].name}</p>`;
        firesUploadBtn.disabled = false;
        firesMessage.innerHTML = '';
      }
    });

    // Перетаскивание
    ['dragenter', 'dragover'].forEach(event => {
      firesDropArea.addEventListener(event, () => {
        firesDropArea.classList.add('highlight');
      });
    });

    ['dragleave', 'drop'].forEach(event => {
      firesDropArea.addEventListener(event, () => {
        firesDropArea.classList.remove('highlight');
      });
    });

    // Обработка drop
    firesDropArea.addEventListener('drop', e => {
      e.preventDefault();
      const dt = e.dataTransfer;
      if (dt.files.length > 0) {
        firesFileInput.files = dt.files;
        firesDropArea.innerHTML = `<p>Выбран: ${dt.files[0].name}</p>`;
        firesUploadBtn.disabled = false;
        firesMessage.innerHTML = '';
      }
    });

    // Отправка
    firesUploadBtn.addEventListener('click', async () => {
      const file = firesFileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);  // ← внимание: file (без s)

      firesMessage.innerHTML = 'Загрузка fires.csv...';
      firesUploadBtn.disabled = true;

      try {
        const response = await fetch('/upload-fires-csv/', {  // ← новый endpoint
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (response.ok) {
          firesMessage.innerHTML = `
        <div class="message success">
          ✅ ${result.message} (${result.rows} строк)
        </div>`;
        } else {
          throw new Error(result.detail);
        }
      } catch (error) {
        firesMessage.innerHTML = `
      <div class="message error">
        ❌ Ошибка: ${error.message}
      </div>`;
      } finally {
        firesUploadBtn.disabled = false;
      }
    });

    // === 3. Просмотр данных ===
    const tableSelect = document.getElementById('tableSelect');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const dataMessage = document.getElementById('dataMessage');
    const dataTable = document.getElementById('dataTable');
    const tableHead = dataTable.querySelector('thead tr');
    const tableBody = dataTable.querySelector('tbody');

    let currentData = [];

    loadDataBtn.addEventListener('click', async () => {
      const table = tableSelect.value;
      dataMessage.innerHTML = 'Загрузка...';
      tableBody.innerHTML = '';
      dataTable.style.display = 'none';

      try {
        const response = await fetch(`/get_data?table=${table}`);
        const result = await response.json();

        if (result.count === 0) {
          dataMessage.innerHTML = 'Нет данных';
          return;
        }

        currentData = result.data;
        const columns = Object.keys(result.data[0]);

        tableHead.innerHTML = '';
        columns.forEach(col => {
          const th = document.createElement('th');
          th.textContent = col;
          th.style.padding = '8px';
          th.style.backgroundColor = '#f0f0f0';
          tableHead.appendChild(th);
        });

        result.data.forEach(row => {
          const tr = document.createElement('tr');
          columns.forEach(col => {
            const td = document.createElement('td');
            td.textContent = row[col] !== null ? row[col] : '';
            td.style.padding = '6px 8px';
            td.style.border = '1px solid #ddd';
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });

        dataTable.style.display = 'table';
        dataMessage.innerHTML = `Загружено: ${result.count} строк`;
      } catch (error) {
        dataMessage.innerHTML = `Ошибка: ${error.message}`;
      }
    });

    // === 4. Экспорт в CSV ===
    exportCsvBtn.addEventListener('click', () => {
      if (currentData.length === 0) {
        alert('Нет данных для экспорта');
        return;
      }

      const table = tableSelect.value;
      const columns = Object.keys(currentData[0]);
      const csvContent = [
        columns.join(','),
        ...currentData.map(row => columns.map(col => {
          let value = row[col];
          if (value === null || value === undefined) value = '';
          value = String(value).replace(/"/g, '""');
          return `"${value}"`;
        }).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${table}_export_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    });

    // === 5. Прогнозные данные ===
    const loadPredBtn = document.getElementById('loadPredBtn');
    const predMessage = document.getElementById('predMessage');
    const predTable = document.getElementById('predTable');
    const predHead = predTable.querySelector('thead tr');
    const predBody = predTable.querySelector('tbody');

    loadPredBtn.addEventListener('click', async () => {
      predMessage.innerHTML = 'Получение прогноза...';
      predBody.innerHTML = '';
      predTable.style.display = 'none';

      try {
        const response = await fetch('/predict/');
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Неизвестная ошибка');
        }
        const result = await response.json();

        if (!result.predictions || result.predictions.length === 0) {
          predMessage.innerHTML = 'Нет прогнозируемых рисков.';
          return;
        }

        const columns = Object.keys(result.predictions[0]);

        // Заголовки
        predHead.innerHTML = '';
        columns.forEach(col => {
          const th = document.createElement('th');
          th.textContent = col;
          th.style.padding = '8px';
          th.style.backgroundColor = '#f0f0f0';
          th.style.border = '1px solid #ddd';
          predHead.appendChild(th);
        });

        // Строки
        result.predictions.forEach(row => {
          const tr = document.createElement('tr');
          columns.forEach(col => {
            const td = document.createElement('td');
            let value = row[col];
            if (value === null || value === undefined) value = '';
            // Форматирование вероятности
            if (col === 'risk_probability') {
              value = (parseFloat(value) * 100).toFixed(2) + '%';
            }
            // Форматирование дат
            if (col === 'predicted_date') {
              const date = new Date(value);
              value = date.toLocaleDateString('ru-RU');
            }
            td.textContent = value;
            td.style.padding = '6px 8px';
            td.style.border = '1px solid #ddd';
            tr.appendChild(td);
          });
          predBody.appendChild(tr);
        });

        predTable.style.display = 'table';
        predMessage.innerHTML = `Прогноз готов: ${result.predictions.length} записей`;
      } catch (error) {
        predMessage.innerHTML = `❌ Ошибка: ${error.message}`;
      }
    });

    const loadMetricsBtn = document.getElementById('loadMetricsBtn');
    const MetricsMessage = document.getElementById('MetricsMessage');
    const MetricsTable = document.getElementById('MetricsTable');
    const MetricsHead = predTable.querySelector('thead tr');
    const MetricsBody = predTable.querySelector('tbody');

    loadMetricsBtn.addEventListener('click', async () => {
      MetricsMessage.innerHTML = 'Получение прогноза...';
      MetricsBody.innerHTML = '';
      MetricsTable.style.display = 'none';

      try {
        const response = await fetch('/predict/');
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Неизвестная ошибка');
        }
        const result = await response.json();

        if (!result.predictions || result.predictions.length === 0) {
          MetricsMessage.innerHTML = 'Нет прогнозируемых рисков.';
          return;
        }

        const columns = Object.keys(result.predictions[0]);

        // Заголовки
        MetricsHead.innerHTML = '';
        columns.forEach(col => {
          const th = document.createElement('th');
          th.textContent = col;
          th.style.padding = '8px';
          th.style.backgroundColor = '#f0f0f0';
          th.style.border = '1px solid #ddd';
          MetricsHead.appendChild(th);
        });

        // Строки
        result.predictions.forEach(row => {
          const tr = document.createElement('tr');
          columns.forEach(col => {
            const td = document.createElement('td');
            let value = row[col];
            if (value === null || value === undefined) value = '';
            // Форматирование вероятности
            if (col === 'risk_probability') {
              value = (parseFloat(value) * 100).toFixed(2) + '%';
            }
            // Форматирование дат
            if (col === 'predicted_date') {
              const date = new Date(value);
              value = date.toLocaleDateString('ru-RU');
            }
            td.textContent = value;
            td.style.padding = '6px 8px';
            td.style.border = '1px solid #ddd';
            tr.appendChild(td);
          });
          MetricsBody.appendChild(tr);
        });

        MetricsTable.style.display = 'table';
        MetricsMessage.innerHTML = `Прогноз готов: ${result.predictions.length} записей`;
      } catch (error) {
        MetricsMessage.innerHTML = `❌ Ошибка: ${error.message}`;
      }
    });
  </script>
</body>

</html>
